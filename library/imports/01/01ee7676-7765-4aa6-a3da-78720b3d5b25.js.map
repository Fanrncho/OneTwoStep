{"version":3,"sources":["../../../../../assets/game/script/assets/game/script/roadManager.js"],"names":["GLB","require","cc","Class","extends","Component","properties","stonePrefab","default","type","Prefab","offsetX","offsetY","stoneSpeed","accDurTime","speedUpPercent","waterBG","Node","deadLine","introduction","onLoad","Game","RoadManager","roadId","roadDatas","curLeftAccTime","roadPool","NodePool","spawnTriggerDis","stones","on","EventType","TOUCH_START","onClickWater","deadLineAnim","getComponent","Animation","initRoad","i","spawnStone","deadLineWarn","animState","getAnimationState","defaultClip","name","isPlaying","play","event","GameManager","gameState","GameState","Play","position","node","convertToNodeSpaceAR","getLocation","player","PlayerManager","y","data","find","temp","ID","jumpRecordId","bind","targetRow","minDistance","Number","MAX_VALUE","row","x","distance","Math","abs","fakeData","line","isDown","jumpPos","push","msg","action","PLAYER_STEP_DATA","sendEvent","spawnStoneNotify","stone","get","instantiate","parent","setSiblingIndex","stoneComponent","init","isRoomOwner","dataFunc","randomNum","ROAD_DATA","sendEventEx","recycleStone","obj","put","speedUp","deadSlowdown","update","dt","moveDis","shift"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAIA,MAAMC,QAAQ,KAAR,CAAV;;AAEAC,GAAGC,KAAH,CAAS;AACLC,aAASF,GAAGG,SADP;;AAGLC,gBAAY;AACRC,qBAAa;AACTC,qBAAS,IADA;AAETC,kBAAMP,GAAGQ;AAFA,SADL;;AAMRC,iBAAS,CAND,EAMI;AACZC,iBAAS,CAPD,EAOI;;AAEZC,oBAAY,CATJ,EASO;AACfC,oBAAY,EAVJ,EAUQ;AAChBC,wBAAgB,GAXR,EAWa;AACrBC,iBAASd,GAAGe,IAZJ;AAaRC,kBAAUhB,GAAGe,IAbL;AAcRE,sBAAcjB,GAAGe;AAdT,KAHP;;AAoBLG,UApBK,oBAoBI;AACLC,aAAKC,WAAL,GAAmB,IAAnB;AACA,aAAKC,MAAL,GAAc,CAAd;AACA,aAAKC,SAAL,GAAiB,EAAjB;AACA,aAAKC,cAAL,GAAsB,KAAKX,UAA3B;AACA,aAAKY,QAAL,GAAgB,IAAIxB,GAAGyB,QAAP,EAAhB;AACA,aAAKC,eAAL,GAAuB,IAAI,KAAKhB,OAAhC;AACA,aAAKiB,MAAL,GAAc,EAAd;;AAEA,aAAKb,OAAL,CAAac,EAAb,CAAgB5B,GAAGe,IAAH,CAAQc,SAAR,CAAkBC,WAAlC,EAA+C,KAAKC,YAApD,EAAkE,IAAlE;AACA,aAAKC,YAAL,GAAoB,KAAKhB,QAAL,CAAciB,YAAd,CAA2BjC,GAAGkC,SAA9B,CAApB;AACH,KA/BI;AAiCLC,YAjCK,sBAiCM;AACP,aAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAI,EAApB,EAAwBA,GAAxB,EAA6B;AACzB,iBAAKC,UAAL;AACH;AACJ,KArCI;;;AAuCLC,kBAAc,wBAAW;AACrB,YAAIC,YAAY,KAAKP,YAAL,CAAkBQ,iBAAlB,CAAoC,KAAKR,YAAL,CAAkBS,WAAlB,CAA8BC,IAAlE,CAAhB;AACA,YAAI,CAACH,UAAUI,SAAf,EAA0B;AACtB,iBAAKX,YAAL,CAAkBY,IAAlB;AACH;AACJ,KA5CI;;AA8CLb,kBAAc,sBAASc,KAAT,EAAgB;AAC1B,YAAI1B,KAAK2B,WAAL,CAAiBC,SAAjB,KAA+BC,UAAUC,IAA7C,EAAmD;AAC/C;AACH;AACD,YAAIC,WAAW,KAAKC,IAAL,CAAUC,oBAAV,CAA+BP,MAAMQ,WAAN,EAA/B,CAAf;AACA,YAAIC,SAASnC,KAAKoC,aAAL,CAAmBD,MAAhC;AACA,YAAIJ,SAASM,CAAT,GAAaF,OAAOH,IAAP,CAAYK,CAAZ,GAAiB,KAAK/C,OAAL,GAAe,CAAjD,EAAqD;AACjD;AACH;;AAED,YAAIgD,OAAOtC,KAAKC,WAAL,CAAiBE,SAAjB,CAA2BoC,IAA3B,CAAgC,UAASC,IAAT,EAAe;AACtD,mBAAOA,KAAKC,EAAL,KAAYN,OAAOO,YAA1B;AACH,SAF0C,CAEzCC,IAFyC,CAEpC,IAFoC,CAAhC,CAAX;;AAIA,YAAIC,YAAY,CAAhB;AACA,YAAIC,cAAcC,OAAOC,SAAzB;AACA,aAAK,IAAI9B,IAAI,CAAb,EAAgBA,KAAK,CAArB,EAAwBA,GAAxB,EAA6B;AACzB,gBAAIA,MAAMqB,KAAKU,GAAf,EAAoB;AAChB,oBAAIC,IAAI,KAAK3D,OAAL,IAAgB2B,IAAI,CAApB,CAAR;AACA,oBAAIiC,WAAWC,KAAKC,GAAL,CAASrB,SAASkB,CAAT,GAAaA,CAAtB,CAAf;AACA,oBAAIC,WAAWL,WAAf,EAA4B;AACxBA,kCAAcK,QAAd;AACAN,gCAAY3B,CAAZ;AACH;AACJ;AACJ;;AAED,YAAIoC,WAAW;AACXZ,gBAAI,CADO;AAEXa,kBAAMhB,KAAKgB,IAFA;AAGXN,iBAAKJ,SAHM;AAIXW,oBAAQ;AAJG,SAAf;AAMAvD,aAAKoC,aAAL,CAAmBD,MAAnB,CAA0BqB,OAA1B,CAAkCC,IAAlC,CAAuCJ,QAAvC;;AAEA,YAAIK,MAAM;AACNC,oBAAQhF,IAAIiF,gBADN;AAENtB,kBAAMe;AAFA,SAAV;AAIArD,aAAK2B,WAAL,CAAiBkC,SAAjB,CAA2BH,GAA3B;AACH,KAtFI;;AAwFLI,sBAAkB,0BAASxB,IAAT,EAAe;AAC7B,aAAKnC,SAAL,CAAesD,IAAf,CAAoBnB,IAApB;AACA,YAAIyB,QAAQ,KAAK1D,QAAL,CAAc2D,GAAd,EAAZ;AACA,YAAI,CAACD,KAAL,EAAY;AACRA,oBAAQlF,GAAGoF,WAAH,CAAe,KAAK/E,WAApB,CAAR;AACH;AACD6E,cAAMG,MAAN,GAAe,KAAKlC,IAApB;AACA+B,cAAMd,CAAN,GAAU,KAAK3D,OAAL,IAAgBgD,KAAKU,GAAL,GAAW,CAA3B,CAAV;AACAe,cAAM1B,CAAN,GAAU,KAAK9C,OAAL,IAAgB+C,KAAKgB,IAAL,GAAY,CAA5B,CAAV;;AAEAS,cAAMI,eAAN,CAAsB,CAAtB;AACA,YAAIC,iBAAiBL,MAAMjD,YAAN,CAAmB,OAAnB,CAArB;AACAsD,uBAAeC,IAAf,CAAoB/B,IAApB;AACA,aAAK9B,MAAL,CAAYiD,IAAZ,CAAiBM,KAAjB;AACH,KAtGI;;AAwGL7C,gBAAY,sBAAW;AACnB,aAAKhB,MAAL;AACA,YAAIvB,IAAI2F,WAAR,EAAqB;AACjB,gBAAIhC,OAAO;AACPG,oBAAI,KAAKvC,MADF;AAEPoD,sBAAM,KAAKpD,MAAL,GAAc,CAFb;AAGP8C,qBAAKuB,SAASC,SAAT,CAAmB,CAAnB,EAAsB,CAAtB;AAHE,aAAX;AAKA,gBAAId,MAAM;AACNC,wBAAQhF,IAAI8F,SADN;AAENnC,sBAAMA;AAFA,aAAV;AAIAtC,iBAAK2B,WAAL,CAAiB+C,WAAjB,CAA6BhB,GAA7B;AACH;AACJ,KAtHI;;AAwHLiB,kBAAc,sBAASC,GAAT,EAAc;AACxB,aAAKvE,QAAL,CAAcwE,GAAd,CAAkBD,GAAlB;AACA,aAAK1D,UAAL;AACH,KA3HI;;AA6HL4D,aAAS,mBAAW;AAChB,aAAKtF,UAAL,IAAmB,KAAKE,cAAxB;AACH,KA/HI;;AAiILqF,kBAAc,wBAAW;AACrB,aAAKvF,UAAL,IAAmB,IAAnB;AACH,KAnII;;AAqILwF,UArIK,kBAqIEC,EArIF,EAqIM;AACP,YAAIjF,KAAK2B,WAAL,CAAiBC,SAAjB,KAA+BC,UAAUC,IAA7C,EAAmD;AAC/C;AACH;AACD,aAAK1B,cAAL,IAAuB6E,EAAvB;AACA,YAAI,KAAK7E,cAAL,GAAsB,CAA1B,EAA6B;AACzB,iBAAKA,cAAL,GAAsB,KAAKX,UAA3B;AACA,iBAAKqF,OAAL;AACA9E,iBAAKoC,aAAL,CAAmBD,MAAnB,CAA0B2C,OAA1B;AACH;AACD,YAAII,UAAU,KAAK1F,UAAL,GAAkByF,EAAhC;AACA,aAAKjD,IAAL,CAAUK,CAAV,IAAe6C,OAAf;AACA,aAAK3E,eAAL,IAAwB2E,OAAxB;AACA,YAAI,KAAK3E,eAAL,GAAuB,CAA3B,EAA8B;AAC1B,iBAAKA,eAAL,GAAuB,KAAKhB,OAA5B;AACA,iBAAK2B,UAAL;AACA,gBAAI6C,QAAQ,KAAKvD,MAAL,CAAY2E,KAAZ,EAAZ;AACA,gBAAIpB,KAAJ,EAAW;AACP,qBAAKY,YAAL,CAAkBZ,KAAlB;AACH;AACJ;AACJ;AA1JI,CAAT","file":"roadManager.js","sourceRoot":"../../../../../assets/game/script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/class.html\n// Learn Attribute:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/reference/attributes.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/creator/en/scripting/life-cycle-callbacks.html\nvar GLB = require(\"Glb\");\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        stonePrefab: {\n            default: null,\n            type: cc.Prefab\n        },\n\n        offsetX: 0, // 石块X偏移\n        offsetY: 0, // 石块Y偏移\n\n        stoneSpeed: 0, // 石头速度--\n        accDurTime: 10, // 加速间隔时间--\n        speedUpPercent: 1.1, // 加速比\n        waterBG: cc.Node,\n        deadLine: cc.Node,\n        introduction: cc.Node\n    },\n\n    onLoad() {\n        Game.RoadManager = this;\n        this.roadId = 0;\n        this.roadDatas = [];\n        this.curLeftAccTime = this.accDurTime;\n        this.roadPool = new cc.NodePool();\n        this.spawnTriggerDis = 3 * this.offsetY;\n        this.stones = [];\n\n        this.waterBG.on(cc.Node.EventType.TOUCH_START, this.onClickWater, this);\n        this.deadLineAnim = this.deadLine.getComponent(cc.Animation);\n    },\n\n    initRoad() {\n        for (var i = 0; i < 25; i++) {\n            this.spawnStone();\n        }\n    },\n\n    deadLineWarn: function() {\n        var animState = this.deadLineAnim.getAnimationState(this.deadLineAnim.defaultClip.name);\n        if (!animState.isPlaying) {\n            this.deadLineAnim.play();\n        }\n    },\n\n    onClickWater: function(event) {\n        if (Game.GameManager.gameState !== GameState.Play) {\n            return;\n        }\n        var position = this.node.convertToNodeSpaceAR(event.getLocation());\n        var player = Game.PlayerManager.player;\n        if (position.y < player.node.y + (this.offsetX / 2)) {\n            return;\n        }\n\n        var data = Game.RoadManager.roadDatas.find(function(temp) {\n            return temp.ID === player.jumpRecordId;\n        }.bind(this));\n\n        var targetRow = 0;\n        var minDistance = Number.MAX_VALUE;\n        for (var i = 1; i <= 4; i++) {\n            if (i !== data.row) {\n                var x = this.offsetX * (i - 1);\n                var distance = Math.abs(position.x - x);\n                if (distance < minDistance) {\n                    minDistance = distance;\n                    targetRow = i;\n                }\n            }\n        }\n\n        var fakeData = {\n            ID: 0,\n            line: data.line,\n            row: targetRow,\n            isDown: true\n        };\n        Game.PlayerManager.player.jumpPos.push(fakeData);\n\n        var msg = {\n            action: GLB.PLAYER_STEP_DATA,\n            data: fakeData\n        };\n        Game.GameManager.sendEvent(msg);\n    },\n\n    spawnStoneNotify: function(data) {\n        this.roadDatas.push(data);\n        var stone = this.roadPool.get();\n        if (!stone) {\n            stone = cc.instantiate(this.stonePrefab);\n        }\n        stone.parent = this.node;\n        stone.x = this.offsetX * (data.row - 1);\n        stone.y = this.offsetY * (data.line - 1);\n\n        stone.setSiblingIndex(0);\n        var stoneComponent = stone.getComponent(\"stone\");\n        stoneComponent.init(data);\n        this.stones.push(stone);\n    },\n\n    spawnStone: function() {\n        this.roadId++;\n        if (GLB.isRoomOwner) {\n            var data = {\n                ID: this.roadId,\n                line: this.roadId + 1,\n                row: dataFunc.randomNum(1, 4)\n            }\n            var msg = {\n                action: GLB.ROAD_DATA,\n                data: data\n            };\n            Game.GameManager.sendEventEx(msg);\n        }\n    },\n\n    recycleStone: function(obj) {\n        this.roadPool.put(obj);\n        this.spawnStone();\n    },\n\n    speedUp: function() {\n        this.stoneSpeed *= this.speedUpPercent;\n    },\n\n    deadSlowdown: function() {\n        this.stoneSpeed *= 0.75;\n    },\n\n    update(dt) {\n        if (Game.GameManager.gameState !== GameState.Play) {\n            return;\n        }\n        this.curLeftAccTime -= dt;\n        if (this.curLeftAccTime < 0) {\n            this.curLeftAccTime = this.accDurTime;\n            this.speedUp();\n            Game.PlayerManager.player.speedUp();\n        }\n        var moveDis = this.stoneSpeed * dt;\n        this.node.y -= moveDis;\n        this.spawnTriggerDis -= moveDis;\n        if (this.spawnTriggerDis < 0) {\n            this.spawnTriggerDis = this.offsetY;\n            this.spawnStone();\n            var stone = this.stones.shift();\n            if (stone) {\n                this.recycleStone(stone);\n            }\n        }\n    },\n});\n"]}